// © Sitecore Corporation A/S. All rights reserved. Sitecore® is a registered trademark of Sitecore Corporation A/S.
import { getCookiesValuesFromEdgeServer, getCookieValueFromMiddlewareRequest, getDefaultCookieAttributes, getGuestIdServer } from '@sitecore-cloudsdk/core/internal';
export async function handleNextJsMiddlewareCookie(request, response, settings, cloudSDKSettings) {
    const middlewareRequest = request;
    const middlewareResponse = response;
    const cookiesValuesFromEdgeServer = getCookiesValuesFromEdgeServer();
    const guestIdCookieValue = getCookieValueFromMiddlewareRequest(middlewareRequest, settings.cookieSettings.name.guestId);
    const browserIdCookieValue = getCookieValueFromMiddlewareRequest(middlewareRequest, cloudSDKSettings.cookieSettings.name.browserId);
    const defaultCookieAttributes = getDefaultCookieAttributes(cloudSDKSettings.cookieSettings.expiryDays, cloudSDKSettings.cookieSettings.domain);
    let guestIdValue;
    if (guestIdCookieValue)
        guestIdValue = guestIdCookieValue;
    else if (cookiesValuesFromEdgeServer?.guestId)
        guestIdValue = cookiesValuesFromEdgeServer.guestId;
    else if (browserIdCookieValue) {
        const guestIdCookieValueFromEdgeProxy = await getGuestIdServer(browserIdCookieValue);
        guestIdValue = guestIdCookieValueFromEdgeProxy;
    }
    else
        return;
    middlewareRequest.cookies.set(settings.cookieSettings.name.guestId, guestIdValue, defaultCookieAttributes);
    middlewareResponse.cookies.set(settings.cookieSettings.name.guestId, guestIdValue, defaultCookieAttributes);
}
