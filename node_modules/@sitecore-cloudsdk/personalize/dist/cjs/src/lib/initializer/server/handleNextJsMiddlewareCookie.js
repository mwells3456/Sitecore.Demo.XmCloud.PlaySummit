"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handleNextJsMiddlewareCookie = void 0;
// © Sitecore Corporation A/S. All rights reserved. Sitecore® is a registered trademark of Sitecore Corporation A/S.
const internal_1 = require("@sitecore-cloudsdk/core/internal");
async function handleNextJsMiddlewareCookie(request, response, settings, cloudSDKSettings) {
    const middlewareRequest = request;
    const middlewareResponse = response;
    const cookiesValuesFromEdgeServer = (0, internal_1.getCookiesValuesFromEdgeServer)();
    const guestIdCookieValue = (0, internal_1.getCookieValueFromMiddlewareRequest)(middlewareRequest, settings.cookieSettings.name.guestId);
    const browserIdCookieValue = (0, internal_1.getCookieValueFromMiddlewareRequest)(middlewareRequest, cloudSDKSettings.cookieSettings.name.browserId);
    const defaultCookieAttributes = (0, internal_1.getDefaultCookieAttributes)(cloudSDKSettings.cookieSettings.expiryDays, cloudSDKSettings.cookieSettings.domain);
    let guestIdValue;
    if (guestIdCookieValue)
        guestIdValue = guestIdCookieValue;
    else if (cookiesValuesFromEdgeServer?.guestId)
        guestIdValue = cookiesValuesFromEdgeServer.guestId;
    else if (browserIdCookieValue) {
        const guestIdCookieValueFromEdgeProxy = await (0, internal_1.getGuestIdServer)(browserIdCookieValue);
        guestIdValue = guestIdCookieValueFromEdgeProxy;
    }
    else
        return;
    middlewareRequest.cookies.set(settings.cookieSettings.name.guestId, guestIdValue, defaultCookieAttributes);
    middlewareResponse.cookies.set(settings.cookieSettings.name.guestId, guestIdValue, defaultCookieAttributes);
}
exports.handleNextJsMiddlewareCookie = handleNextJsMiddlewareCookie;
