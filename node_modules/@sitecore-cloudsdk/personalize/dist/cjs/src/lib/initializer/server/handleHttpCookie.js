"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handleHttpCookie = void 0;
// © Sitecore Corporation A/S. All rights reserved. Sitecore® is a registered trademark of Sitecore Corporation A/S.
const internal_1 = require("@sitecore-cloudsdk/core/internal");
const utils_1 = require("@sitecore-cloudsdk/utils");
async function handleHttpCookie(request, response, settings, cloudSDKSettings) {
    const httpRequest = request;
    const httpResponse = response;
    const cookiesValuesFromEdgeServer = (0, internal_1.getCookiesValuesFromEdgeServer)();
    const guestIdCookie = (0, utils_1.getCookieServerSide)(httpRequest.headers.cookie, settings.cookieSettings.name.guestId);
    const browserIdCookie = (0, utils_1.getCookieServerSide)(httpRequest.headers.cookie, cloudSDKSettings.cookieSettings.name.browserId);
    const defaultCookieAttributes = (0, internal_1.getDefaultCookieAttributes)(cloudSDKSettings.cookieSettings.expiryDays, cloudSDKSettings.cookieSettings.domain);
    let guestIdCookieString;
    if (guestIdCookie)
        guestIdCookieString = (0, utils_1.createCookieString)(settings.cookieSettings.name.guestId, guestIdCookie.value, defaultCookieAttributes);
    else if (cookiesValuesFromEdgeServer?.guestId)
        guestIdCookieString = (0, utils_1.createCookieString)(settings.cookieSettings.name.guestId, cookiesValuesFromEdgeServer.guestId, defaultCookieAttributes);
    else if (browserIdCookie) {
        const guestIdCookieValueFromEdgeProxy = await (0, internal_1.getGuestIdServer)(browserIdCookie.value);
        guestIdCookieString = (0, utils_1.createCookieString)(settings.cookieSettings.name.guestId, guestIdCookieValueFromEdgeProxy, defaultCookieAttributes);
    }
    else
        return;
    if (!guestIdCookie)
        httpRequest.headers.cookie = httpRequest.headers.cookie
            ? httpRequest.headers.cookie + '; ' + guestIdCookieString
            : guestIdCookieString;
    httpResponse.setHeader('Set-Cookie', guestIdCookieString);
}
exports.handleHttpCookie = handleHttpCookie;
