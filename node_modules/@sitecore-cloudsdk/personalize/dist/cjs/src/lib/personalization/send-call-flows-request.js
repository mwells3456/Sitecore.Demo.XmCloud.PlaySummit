"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.sendCallFlowsRequest = void 0;
const internal_1 = require("@sitecore-cloudsdk/core/internal");
const utils_1 = require("@sitecore-cloudsdk/utils");
const consts_1 = require("../consts");
/**
 * A function that sends a CallFlow request to Sitecore EP
 * @param personalizeData - Properties to be send to Sitecore EP
 * @param settings - settings for the url params
 * @param timeout - Optional timeout in milliseconds to cancel the request
 * @returns - A promise that resolves with either the Sitecore EP response object or unknown
 */
async function sendCallFlowsRequest(epCallFlowsBody, settings, opts) {
    const startTimestamp = Date.now();
    let debugResponse = {};
    // eslint-disable-next-line max-len
    const requestUrl = `${settings.sitecoreEdgeUrl}/v1/personalize?sitecoreContextId=${settings.sitecoreEdgeContextId}&siteId=${settings.siteName}`;
    const fetchOptions = {
        body: JSON.stringify(epCallFlowsBody),
        headers: {
            /* eslint-disable @typescript-eslint/naming-convention */
            'Content-Type': 'application/json',
            'X-Library-Version': consts_1.PACKAGE_VERSION,
            'x-sc-correlation-id': (0, internal_1.generateCorrelationId)()
            /* eslint-enable @typescript-eslint/naming-convention */
        },
        method: 'POST'
    };
    if (opts?.userAgent)
        fetchOptions.headers['User-Agent'] = opts.userAgent;
    (0, internal_1.debug)(consts_1.PERSONALIZE_NAMESPACE)('Personalize request: %s with options: %O', requestUrl, fetchOptions);
    if (opts?.timeout === undefined)
        return fetch(requestUrl, fetchOptions)
            .then((response) => {
            debugResponse = (0, internal_1.processDebugResponse)(consts_1.PERSONALIZE_NAMESPACE, response);
            return response.json();
        })
            .then((data) => {
            debugResponse.body = data;
            (0, internal_1.debug)(consts_1.PERSONALIZE_NAMESPACE)('Personalize response in %dms : %O', Date.now() - startTimestamp, debugResponse);
            return data;
        })
            .catch((error) => {
            (0, internal_1.debug)(consts_1.PERSONALIZE_NAMESPACE)('Error personalize response: %O', error);
            return null;
        });
    return (0, utils_1.fetchWithTimeout)(requestUrl, opts.timeout, fetchOptions)
        .then((response) => {
        if (!response)
            return null;
        debugResponse = (0, internal_1.processDebugResponse)(consts_1.PERSONALIZE_NAMESPACE, response);
        return response.json();
    })
        .then((data) => {
        debugResponse.body = data;
        (0, internal_1.debug)(consts_1.PERSONALIZE_NAMESPACE)('Personalize response in %dms : %O', Date.now() - startTimestamp, debugResponse);
        return data;
    })
        .catch((error) => {
        (0, internal_1.debug)(consts_1.PERSONALIZE_NAMESPACE)('Error personalize response: %O', error);
        if (error.message.includes('IV-0006') || error.message.includes('IE-0002'))
            throw new Error(error.message);
        return null;
    });
}
exports.sendCallFlowsRequest = sendCallFlowsRequest;
