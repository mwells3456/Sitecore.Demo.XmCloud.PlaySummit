import { getCloudSDKSettingsServer, getCookieValueFromRequest } from '@sitecore-cloudsdk/core/internal';
import { verifyEventsPackageExistence } from '../../initializer/server/initializer';
import { sendEvent } from '../send-event/sendEvent';
import { PageViewEvent } from './page-view-event';
/**
 * A function that sends a VIEW event to SitecoreCloud API
 *
 * @param request - Interface with constraint for extending request
 * @param pageViewData - The required/optional attributes in order to be send to SitecoreCloud API
 * @returns The response object that Sitecore EP returns
 */
export function pageViewServer(request, pageViewData) {
    verifyEventsPackageExistence();
    const settings = getCloudSDKSettingsServer();
    const browserId = getCookieValueFromRequest(request, settings.cookieSettings.name.browserId);
    // Host is irrelevant but necessary to support relative URL
    const requestUrl = new URL(request.url, `https://localhost`);
    return new PageViewEvent({
        id: browserId,
        pageViewData,
        searchParams: requestUrl.search,
        sendEvent,
        settings
    }).send();
}
